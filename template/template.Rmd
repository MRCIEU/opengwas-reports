---
title: "MR-Base GWAS Pipeline Report"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_scroll: fill
params:
  gwas_id: gwas_id
  bcf_file: bcf_file
  tsv_file: tsv_file
  metadata: metadata
---

```{r setup, include=FALSE, message=FALSE}
library("tidyverse")
library("fs")
library("glue")
library("here")
source(here("funcs/processing.R"))
source(here("funcs/plots.R"))
message(glue("bcf_file: {params$bcf_file}"))
message(glue("tsv_file: {params$tsv_file}"))
message(glue("metadata: {params$metadata}"))
```

```{r load-data, include=FALSE}
df <- read_tsv(params$tsv_file, col_names = FALSE,
               col_types = "cicd") %>%
  set_names(c("CHROM", "POS", "ID", "PVAL")) %>%
  mutate_at(vars(CHROM), translate_chrom_to_int)
meta_metrics <- jsonlite::read_json(params$metadata)
```

Row {data-width=450 .sidebar}
-----------------------------------------------------------------------

### Information {data-height=200}

```{r render-info}
info <- tribble(
  ~name, ~value,
  "gwas_id", params$gwas_id,
  "bcf_file", path_file(params$bcf_file),
  "metadata", path_file(params$metadata),
  "compile_time", format(Sys.time(), "%Y-%m-%d %H:%M %Z"),
  "build_version", "PLACEHOLDER",
)

info %>% knitr::kable()
```

### Metrics

#### Counts

```{r render-metrics-counts}
count_metrics <- meta_metrics$counts

count_metrics %>% enframe() %>%
  mutate(value = value %>%
           map_int( ~ .)) %>% knitr::kable(format.args = list(big.mark = ","))
```

Column {data-width=650} {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Plot 1: Manhattan plot

```{r plot-manhattan}
df %>% plot_manhattan(chr = CHROM, bp = POS, snp = ID, p = PVAL)
```

### Plot 2: QQ plot

```{r plot-qq}
df %>% plot_qq(pval = PVAL)
```

### Plot 3: AF plot

```{r plot-af}
cat("PLACEHOLDER")
```
