---
title: "MR-Base GWAS Pipeline Report"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_scroll: scroll
params:
  gwas_id: gwas_id
  output_dir: output_dir
  bcf_file: bcf_file
  main_df: main_df
  qc_file: qc_file
  metadata_file: metadata_file
  refdata_file: refdata_file
  plot_files: plot_files
---

```{r setup, include=FALSE, message=FALSE}
set.seed(config::get("sample_seed"))
```

```{r load-data, include=FALSE}
main_df <- params$main_df
if (!is.null(gwas_id)) {
  api_data <- params$gwas_id %>% process_api_info()
} else {
  api_data <- NULL
}
trait_name <- get_trait_name(api_data)
metadata <- jsonlite::read_json(params$metadata_file)
qc_metrics <- jsonlite::read_json(params$qc_file)

plot_sample <- config::get("plot_sample")
n_sample <- min(
  config::get("plot_max_snps"),
  config::get("plot_max_frac") * nrow(main_df))
```

# Sidebar {data-width=450 .sidebar}

## MR-Base trait information

Trait: **`r trait_name`**.

```{r render-metadata-api}
if (!is.null(api_data)) {
  api_data %>% knitr::kable()
}
```

## Report information

```{r render-info}
info <- tribble(
  ~name, ~value,
  "gwas_id", params$gwas_id,
  "bcf_file", path_file(params$bcf_file),
  "qc_file", path_file(params$qc_file),
  "metadata", path_file(params$metadata_file),
  "refdata", path_file(params$refdata_file),
  "compile_time", format(Sys.time(), "%Y-%m-%d %H:%M %Z"),
  "build_version", get_build_version(),
)

info %>% knitr::kable()
```

# Summary

## Summary {data-width=650} {.tabset .tabset-fade}

### Manhattan plot

![manhattan_plot](`r params$plot_files$manhattan_plot`)

### QQ plot

![qq_plot](`r params$plot_files$qq_plot`)

### AF plot

![af_plot](`r params$plot_files$af_plot`)

### P-Z plot

![pz_plot](`r params$plot_files$pz_plot`)

### Metadata

<span class=".flowing-content-shim">
```{r display-metadata}
metadata_file %>% read_file() %>% jsonlite::prettify()
```
</span>

### LDSC

<span class=".flowing-content-shim">
```{r display-ldsc}
display_ldsc(params$output_dir)
```
</span>

# QC metrics

## Metrics {.tabset .tabset-fade}

### Metrics

<span class=".flowing-content-shim">
```{r render-qc-metrics}
qc_file %>% read_file() %>% jsonlite::prettify()
```
</span>

### Definitions

<span class=".flowing-content-shim">
```{r qc_metrics, child = here::here('docs/qc_metrics.md')}

```
</span>

# Diagnostics

## Details {.tabset .tabset-fade}

### Summary stats

<span class=".flowing-content-shim">
```{r skimr, results="asis"}
main_df %>% skimr::skim() %>% skimr::kable()
```
</span>

### Head and tail

```{r df-head}
main_df %>% head(n=10) %>% knitr::kable()
```

```{r df-tail}
main_df %>% tail(n=10) %>% knitr::kable()
```

### bcf preview

<span class=".flowing-content-shim">
```{r bcf-preview}
preview <- system(glue("bcftools view -H {bcf_file} | head -n 50"),
                  intern = TRUE)
cat(preview, sep = "\n")
```
</span>
