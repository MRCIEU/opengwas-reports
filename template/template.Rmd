---
title: "MR-Base GWAS Pipeline Report"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_scroll: scroll
params:
  gwas_id: gwas_id
  bcf_file: bcf_file
  main_df: main_df
  qc_file: qc_file
  metadata_file: metadata_file
  refdata_file: refdata_file
  no_mrbase_api: no_mrbase_api
---

```{r setup, include=FALSE, message=FALSE}
library("tidyverse")
library("fs")
library("glue")
library("here")
source(here("funcs/utils.R"))
source(here("funcs/process_report.R"))
source(here("funcs/plots.R"))
```

```{r load-data, include=FALSE}
main_df <- params$main_df
if (!no_mrbase_api) {
  api_data <- params$gwas_id %>% process_api_info()
} else {
  api_data <- NULL
}
trait_name <- get_trait_name(api_data, no_mrbase_api)
metadata <- jsonlite::read_json(params$metadata_file)
qc_metrics <- jsonlite::read_json(params$qc_file)
```

Sidebar {data-width=450 .sidebar}
=======================================================================

### MR-Base trait information

Trait: **`r trait_name`**.

```{r render-metadata-api}
if (!no_mrbase_api) {
  api_data %>% knitr::kable()
}
```

### Report information

```{r render-info}
info <- tribble(
  ~name, ~value,
  "gwas_id", params$gwas_id,
  "bcf_file", path_file(params$bcf_file),
  "qc_file", path_file(params$qc_file),
  "metadata", path_file(params$metadata_file),
  "refdata", path_file(params$refdata_file),
  "compile_time", format(Sys.time(), "%Y-%m-%d %H:%M %Z"),
  "build_version", get_build_version(),
)

info %>% knitr::kable()
```

Summary
=====

Summary {data-width=650} {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Manhattan plot

```{r plot-manhattan, fig.width = 10, fig.height = 6}
main_df %>% plot_manhattan(chr = CHROM, bp = POS, snp = ID, p = PVAL)
```

### QQ plot

```{r plot-qq, fig.width = 10, fig.height = 6}
main_df %>% plot_qq_log(pval = PVAL)
```

### AF plot

```{r plot-af, fig.width = 10, fig.height = 6}
main_df %>% plot_af(af_main = AF, af_ref = AF_reference)
```

### P-Z plot

```{r plot-pz, fig.width = 10, fig.height = 6}
main_df %>% plot_pz(beta = BETA, se = SE, pval = PVAL, pval_ztest = PVAL_ztest)
```

### Metadata

<span class=".flowing-content-shim">
```{r display-metadata}
metadata_file %>% read_file() %>% jsonlite::prettify()
```
</span>

QC metrics
====

<span class=".flowing-content-shim">
```{r render-qc-metrics}
qc_file %>% read_file() %>% jsonlite::prettify()
```
</span>

Diagnostics
=====

Details {.tabset .tabset-fade}
-------------------------------------------------

### Hmisc describe

<span class=".flowing-content-shim">
```{r hmisc-describe}
main_df %>% Hmisc::describe()
```
</span>

### Head and tail

```{r df-head}
main_df %>% head(n=10) %>% knitr::kable()
```

```{r df-tail}
main_df %>% tail(n=10) %>% knitr::kable()
```
