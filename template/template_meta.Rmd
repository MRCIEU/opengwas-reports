---
title: "MR-Base GWAS Meta Report"
output:
  flexdashboard::flex_dashboard:
    theme: yeti
    orientation: rows
    vertical_scroll: scroll
params:
  meta_metrics: meta_metrics
  qc_metrics: qc_metrics
  metadata: metadata
  input_dir: input_dir
  output_dir: output_dir
  meta_metrics_file: meta_metrics_file
  metadata_file: metadata_file
  qc_metrics_file: qc_metrics_file
---

```{r setup, include=FALSE, message=FALSE}
options(width = 100)

metrics <- params$qc_metrics %>%
  names() %>% setdiff(c("ID", "sample_size"))
```

# Sidebar {data-width=450 .sidebar}

## Meta metrics

```{r meta-metrics}
meta_metrics <- params$meta_metrics %>%
  `[[`("metrics") %>% enframe() %>%
  mutate_at(vars(value), flatten_dbl)

meta_metrics %>% knitr::kable()
```

## Report information

```{r render-info}
info <- tribble(
  ~name, ~value,
  "input_dir", params$input_dir,
  "output_dir", params$output_dir,
  "meta_metrics_file", path_file(params$meta_metrics_file),
  "qc_metrics_file", path_file(params$qc_metrics_file),
  "metadata_file", path_file(params$metadata_file),
  "compile_time", format(Sys.time(), "%Y-%m-%d %H:%M %Z"),
  "build_version", get_build_version(),
)

info %>% knitr::kable()
```

# Metrics: scatterplot

## Plots {.tabset .tabset-fade}

```{r meta_scatter, results="asis"}
metrics %>%
  walk(function(metric) {
     cat(glue("\n\n### `{metric}`\n\n"))
     p <- params$qc_metrics %>%
       plot_scatter(x = ID, y = !!rlang::sym(metric))
     print(p)
     cat("\n\n\n\n")
  })
```

# Metrics: histogram

## Plots {.tabset .tabset-fade}

```{r meta_hist, results="asis"}
metrics %>%
  walk(function(metric) {
     cat(glue("\n\n### `{metric}`\n\n"))
     p <- params$qc_metrics %>%
       plot_hist(x = !!rlang::sym(metric))
     print(p)
     cat("\n\n\n\n")
  })
```

# Metrics: head and tails

## Tables {.tabset .tabset-fade}

```{r meta_tails, results="asis"}
metrics %>%
  walk(function(metric) {
     cat(glue("\n\n### `{metric}`\n\n"))
     df <- params$qc_metrics %>%
       arrange(!!rlang::sym(metric)) %>%
       select(ID, !!rlang::sym(metric))
     head <- df %>% head(n=10) %>% knitr::kable()
     tail <- df %>% tail(n=10) %>% knitr::kable()
     cat("**Head**")
     print(head)
     cat("\n\n\n\n")
     cat("**Tail**")
     print(tail)
     cat("\n\n\n\n")
  })
```

# Flags

## QC metrics {.tabset .tabset-fade}

### Allele frequency correlation

Studies with `abs(af_correlation) < 0.7`

```{r flag_af_corr}
params$qc_metrics %>% select(ID, af_correlation) %>%
  filter(abs(af_correlation) < 0.7) %>%
  arrange(af_correlation) %>%
  knitr::kable()
```

### Inflation factor

Studies with `inflation_factor > 1.2`

```{r flag_inflation_factor}
params$qc_metrics %>% select(ID, inflation_factor) %>%
  filter(inflation_factor > 1.2) %>%
  arrange(desc(inflation_factor)) %>%
  knitr::kable()
```

# Diagnostics

## Diagnostics {.tabset .tabset-fade}

### Metadata: glimpse

<span class=".flowing-content-shim">
```{r glimpse-metadata}
params$metadata %>% glimpse()
```
</span>

### Metadata: describe

<span class=".flowing-content-shim">
```{r skimr-metadata, results="asis"}
params$metadata %>% skimr::skim() %>% skimr::kable()
```
</span>

### Metadata: head and tails

```{r head-metadata}
params$metadata %>% head(n=10) %>% knitr::kable()
```

```{r tail-metadata}
params$metadata %>% tail(n=10) %>% knitr::kable()
```

### QC metrics: glimpse

<span class=".flowing-content-shim">
```{r glimpse-qc-metrics}
params$qc_metrics %>% glimpse()
```
</span>

### QC metrics: describe

<span class=".flowing-content-shim">
```{r skimr-qc-metrics, results="asis"}
params$qc_metrics %>% skimr::skim() %>% skimr::kable()
```
</span>

### QC metrics: head and tails

```{r head-qc-metrics}
params$qc_metrics %>% head(n=10) %>% knitr::kable()
```

```{r tail-qc-metrics}
params$qc_metrics %>% tail(n=10) %>% knitr::kable()
```

### QC metrics: definitions

<span class=".flowing-content-shim">
```{r qc_metrics, child = 'qc_metrics.md'}

```
</span>
