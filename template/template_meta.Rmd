---
title: "MR-Base GWAS Meta Report"
output:
  flexdashboard::flex_dashboard:
    theme: journal
    orientation: rows
    vertical_scroll: scroll
params:
  qc_metrics: qc_metrics
  metadata: metadata
  input_dir: input_dir
  output_dir: output_dir
  metadata_file: metadata_file
  qc_metrics_file: qc_metrics_file
---

```{r setup, include=FALSE, message=FALSE}
library("tidyverse")
library("fs")
library("glue")
library("here")
source(here("funcs/utils.R"))
source(here("funcs/meta_plots.R"))
```

Sidebar {data-width=450 .sidebar}
=======================================================================

### Meta metrics

```{r meta-metrics}
meta_metrics <- tribble(
  ~name, ~value,
  "num_studies", NA,
  "num_valid_studies", nrow(qc_metrics),
)
```

### Report information

```{r render-info}
info <- tribble(
  ~name, ~value,
  "input_dir", params$input_dir,
  "output_dir", params$output_dir,
  "qc_metrics_file", path_file(params$qc_metrics_file),
  "metadata_file", path_file(params$metadata_file),
  "compile_time", format(Sys.time(), "%Y-%m-%d %H:%M %Z"),
  "build_version", get_build_version(),
)

info %>% knitr::kable()
```

QC metrics
====

QC metrics {.tabset .tabset-fade}
-------------------------------------------------

### Allele frequency correlation

```{r plot_af_corr}
params$qc_metrics %>% plot_scatter(x = sample_size, y = af_correlation)
```

### Inflation factor

```{r plot_inflation_factor}
params$qc_metrics %>% plot_scatter(x = sample_size, y = inflation_factor)
```

Flags
====

QC metrics {.tabset .tabset-fade}
-------------------------------------------------

### Allele frequency correlation

Studies with `af_correlation < 0.7`

```{r flag_af_corr}
params$qc_metrics %>% select(ID, af_correlation) %>%
  filter(af_correlation < 0.7) %>%
  arrange(af_correlation) %>%
  knitr::kable()
```

### Inflation factor

Studies with `inflation_factor > 1.2`

```{r flag_inflation_factor}
params$qc_metrics %>% select(ID, inflation_factor) %>%
  filter(inflation_factor > 1.2) %>%
  arrange(desc(inflation_factor)) %>%
  knitr::kable()
```

Diagnostics
=====

Diagnostics {.tabset .tabset-fade}
-------------------------------------------------

### Metadata

<span class=".flowing-content-shim">
```{r hmisc-metadata}
params$metadata %>% Hmisc::describe()
```
</span>

### QC metrics

<span class=".flowing-content-shim">
```{r hmisc-qc-metrics}
params$qc_metrics %>% Hmisc::describe()
```
</span>
