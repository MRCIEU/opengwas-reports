---
title: "MR-Base GWAS Meta Report"
output:
  flexdashboard::flex_dashboard:
    theme: flatly
    orientation: rows
    vertical_scroll: scroll
params:
  meta_metrics: meta_metrics
  qc_metrics: qc_metrics
  metadata: metadata
  input_dir: input_dir
  output_dir: output_dir
  meta_metrics_file: meta_metrics_file
  metadata_file: metadata_file
  qc_metrics_file: qc_metrics_file
---

```{r setup, include=FALSE, message=FALSE}
options(width = 100)
```

Sidebar {data-width=450 .sidebar}
=======================================================================

### Meta metrics

```{r meta-metrics}
meta_metrics <- params$meta_metrics %>%
  `[[`("metrics") %>% enframe() %>%
  mutate_at(vars(value), flatten_dbl)

meta_metrics %>% knitr::kable()
```

### Report information

```{r render-info}
info <- tribble(
  ~name, ~value,
  "input_dir", params$input_dir,
  "output_dir", params$output_dir,
  "meta_metrics_file", path_file(params$meta_metrics_file),
  "qc_metrics_file", path_file(params$qc_metrics_file),
  "metadata_file", path_file(params$metadata_file),
  "compile_time", format(Sys.time(), "%Y-%m-%d %H:%M %Z"),
  "build_version", get_build_version(),
)

info %>% knitr::kable()
```

QC metrics
====

QC metrics {.tabset .tabset-fade}
-------------------------------------------------

### Allele frequency correlation

```{r plot_af_corr}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = af_correlation)
```

### Inflation factor

```{r plot_inflation_factor}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = inflation_factor)
```

### Clumped hits

```{r plot_clumped_hits}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = clumped_hits)
```

### `count_p_sig`

```{r plot_count_p_sig}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = count_p_sig)
```

### `count_mono`

```{r plot_count_mono}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = count_mono)
```

### `count_ns`

```{r plot_count_ns}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = count_ns)
```

### `n_miss_EFFECT`

```{r plot_n_miss_EFFECT}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = n_miss_EFFECT)
```

### `n_miss_PVAL`

```{r plot_n_miss_PVAL}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = n_miss_PVAL)
```

### `n_miss_AF`

```{r plot_n_miss_AF}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = n_miss_AF)
```

### `n_miss_AF_reference`

```{r plot_n_miss_AF_reference}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = n_miss_AF_reference)
```

### `n_est`

```{r plot_n_est}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = n_est)
```

### `n_est_sqrt`

```{r plot_n_est_sqrt}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = n_est_sqrt)
```

### `sd_y_est1`

```{r plot_sd_y_est1}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = sd_y_est1)
```

### `sd_y_est2`

```{r plot_sd_y_est2}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = sd_y_est2)
```

### `r2_sum1`

```{r plot_r2_sum1}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = r2_sum1)
```

### `r2_sum2`

```{r plot_r2_sum2}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = r2_sum2)
```

### `r2_sum3`

```{r plot_r2_sum3}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = r2_sum3)
```

### `r2_sum5`

```{r plot_r2_sum5}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = r2_sum5)
```

### `ldsc_nsnp_merge_refpanel_ld`

```{r plot_ldsc_nsnp_merge_refpanel_ld}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = ldsc_nsnp_merge_refpanel_ld)
```

### `ldsc_nsnp_merge_regression_ld`

```{r plot_ldsc_nsnp_merge_regression_ld}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = ldsc_nsnp_merge_regression_ld)
```

### `ldsc_observed_scale_h2_beta`

```{r plot_ldsc_observed_scale_h2_beta}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = ldsc_observed_scale_h2_beta)
```

### `ldsc_observed_scale_h2_se`

```{r plot_ldsc_observed_scale_h2_se}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = ldsc_observed_scale_h2_se)
```

### `ldsc_intercept_beta`

```{r plot_ldsc_intercept_beta}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = ldsc_intercept_beta)
```

### `ldsc_intercept_se`

```{r plot_ldsc_intercept_se}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = ldsc_intercept_se)
```

### `ldsc_lambda_gc`

```{r plot_ldsc_lambda_gc}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = ldsc_lambda_gc)
```

### `ldsc_mean_chisq`

```{r plot_ldsc_mean_chisq}
params$qc_metrics %>%
  plot_scatter(x = sample_size, y = ldsc_mean_chisq)
```

Flags
====

QC metrics {.tabset .tabset-fade}
-------------------------------------------------

### Allele frequency correlation

Studies with `abs(af_correlation) < 0.7`

```{r flag_af_corr}
params$qc_metrics %>% select(ID, af_correlation) %>%
  filter(abs(af_correlation) < 0.7) %>%
  arrange(af_correlation) %>%
  knitr::kable()
```

### Inflation factor

Studies with `inflation_factor > 1.2`

```{r flag_inflation_factor}
params$qc_metrics %>% select(ID, inflation_factor) %>%
  filter(inflation_factor > 1.2) %>%
  arrange(desc(inflation_factor)) %>%
  knitr::kable()
```

Diagnostics
=====

Diagnostics {.tabset .tabset-fade}
-------------------------------------------------

### Metadata: glimpse

<span class=".flowing-content-shim">
```{r glimpse-metadata}
params$metadata %>% glimpse()
```
</span>

### Metadata: describe

<span class=".flowing-content-shim">
```{r skimr-metadata, results="asis"}
params$metadata %>% skimr::skim() %>% skimr::kable()
```
</span>

### Metadata: head and tails

```{r head-metadata}
params$metadata %>% head(n=10) %>% knitr::kable()
```

```{r tail-metadata}
params$metadata %>% tail(n=10) %>% knitr::kable()
```

### QC metrics: glimpse

<span class=".flowing-content-shim">
```{r glimpse-qc-metrics}
params$qc_metrics %>% glimpse()
```
</span>

### QC metrics: describe

<span class=".flowing-content-shim">
```{r skimr-qc-metrics, results="asis"}
params$qc_metrics %>% skimr::skim() %>% skimr::kable()
```
</span>

### QC metrics: head and tails

```{r head-qc-metrics}
params$qc_metrics %>% head(n=10) %>% knitr::kable()
```

```{r tail-qc-metrics}
params$qc_metrics %>% tail(n=10) %>% knitr::kable()
```

### QC metrics: definitions

<span class=".flowing-content-shim">
```{r qc_metrics, child = 'qc_metrics.md'}

```
</span>
